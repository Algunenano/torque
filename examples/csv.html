<!DOCTYPE html>
<html>
    <head>
        <link rel="stylesheet" href="vendor/leaflet.css"/>
        <style>
            #map, html, body {
                width: 100%;
                height: 95%;
                padding: 0;
                margin: 0;
            }
            #control {
                display:block;
                z-index: 10000;
                position: absolute;
                left: 10px;
                bottom: 10px;
                background: #fff;
                border-radius: 50%;
                box-shadow: 0 0 4px rgba(0, 0, 0, .2);
                padding: 8px;
                margin: 0;
                cursor: pointer;
            }
            #control:hover {
                background: #f5f5f5;
            }
            #control span {
                display: block;
                width: 12px;
                height: 12px;
                vertical-align: middle;
                position:relative
            }
            #control span.play:before {
                content:"";
                position: absolute;
                display: block;
                height: 10px;
                width: 3px;
                background: #666;
                left: 2px;
                top: 1px;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
            }
            #control span.play:after {
                content:"";
                position: absolute;
                display: block;
                height: 10px;
                width: 3px;
                background: #666;
                right: 1px;
                top: 1px;
                -webkit-border-radius: 4px;
                -moz-border-radius: 4px;
                border-radius: 4px;
            }

            #control span.pause:before {
                content:"";
                position: absolute;
                display: block;
                height: 0px;
                width: 0px;
                border: 6px solid transparent;
                border-left: 8px solid #666;
                left: 3px;

            }
        </style>
    </head>
    <body>
        <style type="text/css">
            #timeline {
                background: rgba(0, 0, 0, .6);
                position: absolute;
                right: 0;
                bottom: 0;
                left: 0;
                padding: 25px 20px 20px 50px;
                z-index: 1000;
                overflow: visible;
            }
            .timeline-inner {
                border-radius: 50px;
                height: 6px;
                background: #fff;
            }
            .timeline-progress{
                display: inline-block;
                border-radius: 50px;
                height: 6px;
                background: #0090D7;
                vertical-align: top;
                position: relative;
            }
            .timeline-progress > span {
                width: 18px;
                height: 18px;
                position: absolute;
                top: -8px;
                right: 0;
                background: #FFFFFF;
                display: inline-block;
                border-radius: 50%;
                border: 1px solid rgba(0, 0, 0, .2);
                box-shadow: 0px 1px 2px 0px rgba(0,0,0,0.30);
            }
            #filter {
                z-index: 10;
                position: absolute;
                right: 10px;
                top: 10px;
                background: #fff;
                border-radius: 4px;
                box-shadow: 0 0 4px rgba(0, 0, 0, .2);
                padding: 8px 12px;
                margin: 0;
                cursor: pointer;
            }
            #filter:hover {
                background: #f5f5f5;
            }

            #filter *:focus {
              outline: none;
            }
            #filter  p {
                display: inline-block;
                vertical-align: middle;
                font-size: 12px;
                margin-right: 4px;
            }
            #filter input[type=checkbox] {
              cursor: pointer;
              -webkit-appearance: none;
                 -moz-appearance: none;
                      appearance: none;
            }
            #filter input[type=checkbox].toogle {
              border: 0;
              box-shadow: inset 0 1px 0 rgba(0, 0, 0, .1);
              background: #ddd;
              border-radius: 50px;
              width: 36px;
              height: 20px;
              position: relative;
              display: inline-block;
              vertical-align: middle;
            }
            #filter input[type=checkbox].toogle:before {
              content: "";
              top: 4px;
              left: 4px;
              position: absolute;
              width: 12px;
              height: 12px;
              background: #fff;
              border-radius: 50%;
              position: absolute;
              box-shadow: 0 1px 0 rgba(0, 0, 0, .1);
            }
            #filter input[type=checkbox]:checked.toogle {
              background: #8FB83F
            }
            #filter input[type=checkbox]:checked.toogle:before {
              left: auto;
              right: 4px;
            }


        </style>
        <input type="file" id="files" name="files" />
        <div id="map">
            <div id="control"><span class="play"></span></div>
            <div id="filter">
                <p>Filter zone</p>
                <input type="checkbox" class="toogle" name="foo" value="foo">
             </div>
            <div id="timeline">
                <div class="timeline-inner">
                    <div class="timeline-progress" style="width: 50%;">
                        <span></span>
                    </div>
                </div>
            </div>
        </div>

        <script src="vendor/leaflet.js"></script>
        <script src="vendor/papaparse.min.js"></script>
        <script src="../dist/torque.full.uncompressed.js"></script>


        <script>
            var map = new L.Map('map', {
                zoomControl: true,
                center: [40, 0],
                zoom: 6
            });

            L.tileLayer('http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors, &copy; <a href="http://cartodb.com/attributions">CartoDB</a>'
            }).addTo(map);

            var CARTOCSS_NORMAL = [
                'Map {',
                '}',
                '#layer{',
                '  comp-op: lighter;',
                '  marker-line-color: #FFF;',
                '  marker-line-width: 0;',
                '  marker-line-opacity: 1;',
                '  marker-type: ellipse;',
                '  marker-width: 2;',
                '  marker-fill: #FF6600;',
                '  marker-opacity: 0.1',
                '}',
                '#layer::point2 {',
                '  marker-width: 1;',
                '  marker-fill: #FF6600;',
                '  marker-fill-opacity: 1;',
                '  marker-line-color: #fff;',
                '  marker-line-width: 1;',
                '  marker-line-opacity: 0;',
                '}',
                '#layer::point3 {',
                '  marker-width: 4;',
                '  marker-fill: #ff6600;',
                '  marker-fill-opacity: .2;',
                '  marker-line-color: #fff;',
                '  marker-line-width: 1;',
                '  marker-line-opacity: 0;',
                '}',
                '#layer::point {',
                '  marker-width: 6;',
                '  marker-fill: #ff6600;',
                '  marker-fill-opacity: 0;',
                '  marker-line-color: #ff6600;',
                '  marker-line-width: 1;',
                '  marker-line-opacity: .1;',
                '}',
                '#layer[frame-offset=1] {',
                '  marker-width:2;',
                '  marker-opacity:0.45;',
                '}',
                '#layer[frame-offset=2]{',
                '  marker-width:4;',
                '  marker-opacity:0.225;',
                '}',
                '#layer[frame-offset=3]{',
                '  marker-width:6;',
                '  marker-opacity:0.1;',
                '}',
                '#layer[frame-offset=4]{',
                '  marker-width:8;',
                '  marker-opacity:0.05;',
                '}',
                '#layer[frame-offset=5]{',
                '  marker-width:10;',
                '  marker-opacity:0.02;',
                '}'
            ].join('\n');

            var CARTOCSS_INTENSITY = [
                    'Map {',
                    '}',
                    '#layer {',
                    '  image-filters: colorize-alpha(blue, cyan, lightgreen, yellow , orange, red);',
                    '  marker-file: url(http://s3.amazonaws.com/com.cartodb.assets.static/alphamarker.png);',
                    '  marker-fill-opacity: 0.4*[value];',
                    '  marker-width: 35;',
                    '}'
            ].join('\n');

            var pointsToLoad = 50000;

            var animationDuration = 60;
            var steps = 2048;
            var cumulative = false;
            var loop = true;
            var cartocss = CARTOCSS_NORMAL;

            var torqueLayer = new L.TorqueLayer({
                provider: 'internal',
                loop: loop,
                steps: steps,
                animationDuration: animationDuration,
                data_aggregation: cumulative ? "cumulative" : undefined,
                cartocss: cartocss
            });

            torqueLayer.addTo(map);

            function handleFileSelect(evt) {
                var file = evt.target.files[0];

                Papa.parse(file, {
                    complete: function (results) {
                        for (var i = 1; i <= pointsToLoad && i < results.data.length; i++) {
                            var point = results.data[i];
                            torqueLayer.provider.addPoint(point[1], point[0], point[3], point[2]);
                        }
                        torqueLayer.provider.setReady();
                        document.getElementById('control').style.visibility = "visible";
                        torqueLayer.play();

                    }
                });
            }
            document.getElementById('files').addEventListener('change', handleFileSelect, false);

            function handlePlayPause(evt) {
                if (torqueLayer.isRunning()) {
                    torqueLayer.pause();
                } else {
                    torqueLayer.play();
                }
            }
            document.getElementById('control').addEventListener('click', handlePlayPause, false);
        </script>
    </body>
</html>

