
<html>
  <link rel="stylesheet" href="../vendor/leaflet.css" />
  <style>
    #map, html, body {
      width: 100%; height: 100%; padding: 0; margin: 0;
    }
  </style>
  <body>
    <div id="map"></div>

    <script src="../vendor/leaflet.js"></script>
    <script src="../lib/torque/request.js"></script>
    <script src="../lib/torque/leaflet/leaflet_tileloader_mixin.js"></script>
    <script src="../lib/torque/leaflet/canvas_layer.js"></script>
    <script src="../lib/torque/renderer/point.js"></script>
    <script src="../lib/torque/provider.json.js"></script>


    <script>
      var map = new L.Map('map', {
        zoomControl: true,
        //center: [43, 0],
        center: [60.20639271653636, 25.004882812],
        zoom: 13
      });


      L.TorqueLayer = L.CanvasLayer.extend({

        initialize: function(options) {
          var self = this;
          options.tileLoader = true;
          this.key = 0;

          L.CanvasLayer.prototype.initialize.call(this, options);
          this.provider = new torque.providers.json(options);
          this.renderer = new torque.renderer.Point(this.getCanvas(), options);
          
          // for each tile shown on the map request the data
          this.on('tileAdded', function(t) {
            var tileData = this.provider.getTileData(t, t.zoom, function(tileData) {
              self._tileLoaded(t, tileData);
              self.redraw();
            });
          }, this);
        },

        render: function() {
          var canvas = this.getCanvas();
          canvas.width = canvas.width;
          var ctx = canvas.getContext('2d');

          //ctx.clearRect(0, 0, canvas.width, canvas.height);
          for(var t in this._tiles) {
            var tile = this._tiles[t];
            var pos = this.getTilePos(tile.coord);
            ctx.setTransform(1, 0, 0, 1, pos.x, pos.y);
            this.renderer.renderTile(tile, this.key);
          }
        },

        setKey: function(t) {
          this.key = t;
          this.redraw();
        }

      });

      L.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png', {
        attribution: 'Stamen'
      }).addTo(map);

      var torqueLayer = new L.TorqueLayer({
        url: 'http://development.localhost.lan:8080/api/v1/sql',
        resolution: 1,
        start_date: 0,
        end_date: 220,
        step: 1,
        table: 'importing_1369045322_helsinki_manydays_live',
        column: 'ac',
        countby: 'count(mm)',
        pixel_size: 3
      });

      torqueLayer.addTo(map);

        torqueLayer.setKey(1);
      var t = 0;
      setInterval(function() {
        torqueLayer.setKey(t++%200);
      }, 16);
    
    </script>
  </body>
</html>

